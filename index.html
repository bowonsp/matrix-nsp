import React, { useState, useEffect } from 'react';
import { Droplets, LogOut, Plus, FileText, Building2, Trash2, Edit2, X } from 'lucide-react';

export default function App() {
  const [user, setUser] = useState(null);
  const [tab, setTab] = useState('input');
  const [customers, setCustomers] = useState([]);
  const [records, setRecords] = useState([]);
  const [users, setUsers] = useState([]);
  const [loginForm, setLoginForm] = useState({ u: '', p: '' });
  const [custForm, setCustForm] = useState({ name: '', location: '', business: '' });
  const [meterForm, setMeterForm] = useState({ cid: '', month: '', date: '', reading: '' });
  const [editRec, setEditRec] = useState(null);
  const [del, setDel] = useState({ show: false, type: '', id: null, name: '' });
  const [msg, setMsg] = useState({ txt: '', type: '' });

  const months = ['JANUARI','FEBRUARI','MARET','APRIL','MEI','JUNI','JULI','AGUSTUS','SEPTEMBER','OKTOBER','NOVEMBER','DESEMBER'];

  useEffect(() => { loadData(); }, []);
  useEffect(() => { if (user) saveData(); }, [customers, records, users, user]);

  async function loadData() {
    try {
      const u = await window.storage.get('users_v2');
      const c = await window.storage.get('customers_v2');
      const r = await window.storage.get('records_v2');
      
      if (u) {
        setUsers(JSON.parse(u.value));
      } else {
        const def = [
          { id: 1, u: 'admin', p: 'admin123', n: 'NOOR SOTYO PRABOWO', r: 'kepala' },
          { id: 2, u: 'petugas', p: 'petugas123', n: 'HARTI WIDIYANINGSIH', r: 'petugas' }
        ];
        setUsers(def);
        await window.storage.set('users_v2', JSON.stringify(def));
      }
      if (c) setCustomers(JSON.parse(c.value));
      if (r) setRecords(JSON.parse(r.value));
    } catch (e) {
      setUsers([
        { id: 1, u: 'admin', p: 'admin123', n: 'NOOR SOTYO PRABOWO', r: 'kepala' },
        { id: 2, u: 'petugas', p: 'petugas123', n: 'HARTI WIDIYANINGSIH', r: 'petugas' }
      ]);
    }
  }

  async function saveData() {
    try {
      await window.storage.set('users_v2', JSON.stringify(users));
      await window.storage.set('customers_v2', JSON.stringify(customers));
      await window.storage.set('records_v2', JSON.stringify(records));
    } catch (e) {
      console.error(e);
    }
  }

  function showMsg(txt, type) {
    setMsg({ txt, type });
    setTimeout(() => setMsg({ txt: '', type: '' }), 3000);
  }

  function login() {
    const found = users.find(x => x.u === loginForm.u && x.p === loginForm.p);
    if (found) {
      setUser(found);
      setLoginForm({ u: '', p: '' });
    } else {
      showMsg('Username atau password salah', 'error');
    }
  }

  function addCust() {
    if (!custForm.name || !custForm.location) {
      showMsg('Nama dan lokasi wajib diisi', 'error');
      return;
    }
    setCustomers([...customers, { id: Date.now(), ...custForm }]);
    setCustForm({ name: '', location: '', business: '' });
    showMsg('Pengguna berhasil ditambahkan', 'success');
  }

  function delItem() {
    const { type, id } = del;
    if (type === 'customer') {
      setCustomers(customers.filter(c => c.id !== id));
      setRecords(records.filter(r => r.cid !== id));
      showMsg('Pengguna berhasil dihapus', 'success');
    } else if (type === 'record') {
      setRecords(records.filter(r => r.id !== id));
      showMsg('Pencatatan berhasil dihapus', 'success');
    }
    setDel({ show: false, type: '', id: null, name: '' });
  }

  function getPrev() {
    if (!meterForm.cid || !meterForm.month) return null;
    const idx = months.indexOf(meterForm.month);
    const recs = records.filter(r => r.cid === parseInt(meterForm.cid));
    for (let i = idx - 1; i >= 0; i--) {
      const prev = recs.filter(r => r.month === months[i]);
      if (prev.length > 0) return prev.sort((a, b) => b.date - a.date)[0].reading;
    }
    return null;
  }

  function calcVol() {
    const prev = getPrev();
    if (prev !== null && meterForm.reading) {
      const vol = parseInt(meterForm.reading) - prev;
      return vol > 0 ? vol : 0;
    }
    return 0;
  }

  function addRec() {
    if (!meterForm.cid || !meterForm.reading || !meterForm.month || !meterForm.date) {
      showMsg('Semua field wajib diisi', 'error');
      return;
    }
    const exists = records.find(r => r.cid === parseInt(meterForm.cid) && r.month === meterForm.month);
    if (exists) {
      showMsg('Sudah ada data untuk bulan ini', 'error');
      return;
    }
    const prev = getPrev();
    const reading = parseInt(meterForm.reading);
    if (prev !== null && reading < prev) {
      showMsg('Meteran akhir tidak boleh lebih kecil dari meteran awal', 'error');
      return;
    }
    const cust = customers.find(c => c.id === parseInt(meterForm.cid));
    setRecords([...records, {
      id: Date.now(),
      cid: parseInt(meterForm.cid),
      name: cust.name,
      month: meterForm.month,
      date: parseInt(meterForm.date),
      reading: reading,
      prev: prev || 0,
      vol: calcVol(),
      by: user.n
    }]);
    setMeterForm({ cid: '', month: '', date: '', reading: '' });
    showMsg('Pencatatan berhasil disimpan', 'success');
  }

  function editRecord(r) {
    setEditRec(r);
    setMeterForm({ cid: r.cid.toString(), month: r.month, date: r.date.toString(), reading: r.reading.toString() });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function updateRec() {
    if (!meterForm.cid || !meterForm.reading || !meterForm.month || !meterForm.date) {
      showMsg('Semua field wajib diisi', 'error');
      return;
    }
    const prev = getPrev();
    const reading = parseInt(meterForm.reading);
    if (prev !== null && reading < prev) {
      showMsg('Meteran akhir tidak boleh lebih kecil dari meteran awal', 'error');
      return;
    }
    const cust = customers.find(c => c.id === parseInt(meterForm.cid));
    setRecords(records.map(r => r.id === editRec.id ? {
      ...r,
      month: meterForm.month,
      date: parseInt(meterForm.date),
      reading: reading,
      prev: prev || 0,
      vol: calcVol(),
      name: cust.name
    } : r));
    setMeterForm({ cid: '', month: '', date: '', reading: '' });
    setEditRec(null);
    showMsg('Data berhasil diupdate', 'success');
  }

  if (!user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <Droplets className="w-16 h-16 mx-auto mb-4 text-green-600" />
            <h1 className="text-2xl font-bold">MATRIKS NSP 2025</h1>
            <p className="text-gray-600 mt-2">Pencatatan Meteran Air Tanah</p>
            <p className="text-sm text-gray-500">Kabupaten Bantul</p>
          </div>
          {msg.txt && (
            <div className={`p-3 rounded mb-4 text-sm ${msg.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
              {msg.txt}
            </div>
          )}
          <div className="space-y-4">
            <input
              type="text"
              value={loginForm.u}
              onChange={e => setLoginForm({ ...loginForm, u: e.target.value })}
              onKeyPress={e => e.key === 'Enter' && login()}
              className="w-full px-4 py-3 border rounded-lg"
              placeholder="Username"
            />
            <input
              type="password"
              value={loginForm.p}
              onChange={e => setLoginForm({ ...loginForm, p: e.target.value })}
              onKeyPress={e => e.key === 'Enter' && login()}
              className="w-full px-4 py-3 border rounded-lg"
              placeholder="Password"
            />
            <button onClick={login} className="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700">
              Masuk
            </button>
          </div>
          <div className="mt-6 pt-6 border-t text-xs text-gray-600 text-center">
            <p><strong>Demo:</strong> admin/admin123 atau petugas/petugas123</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {del.show && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl p-6 max-w-md w-full">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-lg font-bold">Konfirmasi Hapus</h3>
              <button onClick={() => setDel({ show: false, type: '', id: null, name: '' })}>
                <X className="w-5 h-5" />
              </button>
            </div>
            <p className="mb-6">Yakin hapus <strong>{del.name}</strong>?</p>
            <div className="flex gap-3">
              <button onClick={() => setDel({ show: false, type: '', id: null, name: '' })} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg">
                Batal
              </button>
              <button onClick={delItem} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg">
                Hapus
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="bg-green-600 text-white shadow-lg">
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <div>
            <h1 className="text-xl font-bold">MATRIKS NSP 2025</h1>
            <p className="text-sm">Kab. Bantul</p>
          </div>
          <div className="text-right">
            <p className="font-bold">{user.n}</p>
            <button onClick={() => setUser(null)} className="mt-1 px-4 py-1 bg-green-700 rounded text-sm">
              Keluar
            </button>
          </div>
        </div>
      </div>

      <div className="container mx-auto px-4 py-6">
        <div className="flex gap-2 mb-6 overflow-x-auto">
          <button onClick={() => setTab('pengguna')} className={`px-6 py-3 rounded-lg font-medium flex items-center gap-2 whitespace-nowrap ${tab === 'pengguna' ? 'bg-green-600 text-white' : 'bg-white'}`}>
            <Building2 className="w-5 h-5" />
            Pengguna
          </button>
          <button onClick={() => setTab('input')} className={`px-6 py-3 rounded-lg font-medium flex items-center gap-2 whitespace-nowrap ${tab === 'input' ? 'bg-green-600 text-white' : 'bg-white'}`}>
            <Plus className="w-5 h-5" />
            Input
          </button>
          <button onClick={() => setTab('matrix')} className={`px-6 py-3 rounded-lg font-medium flex items-center gap-2 whitespace-nowrap ${tab === 'matrix' ? 'bg-green-600 text-white' : 'bg-white'}`}>
            <FileText className="w-5 h-5" />
            Matriks
          </button>
        </div>

        {msg.txt && (
          <div className={`p-4 rounded-lg mb-6 ${msg.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
            {msg.txt}
          </div>
        )}

        {tab === 'pengguna' && (
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-bold mb-4">Tambah Pengguna</h2>
              <div className="space-y-3">
                <input type="text" value={custForm.name} onChange={e => setCustForm({ ...custForm, name: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="Nama *" />
                <input type="text" value={custForm.location} onChange={e => setCustForm({ ...custForm, location: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="Lokasi *" />
                <input type="text" value={custForm.business} onChange={e => setCustForm({ ...custForm, business: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="Jenis Usaha" />
                <button onClick={addCust} className="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                  Simpan
                </button>
              </div>
            </div>
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-bold mb-4">Daftar ({customers.length})</h2>
              <div className="space-y-2 max-h-96 overflow-y-auto">
                {customers.length === 0 ? (
                  <p className="text-center text-gray-400 py-8">Belum ada data</p>
                ) : (
                  customers.map(c => (
                    <div key={c.id} className="border rounded p-3 flex justify-between items-center">
                      <div>
                        <p className="font-bold text-sm">{c.name}</p>
                        <p className="text-xs text-gray-600">{c.location}</p>
                      </div>
                      <button onClick={() => setDel({ show: true, type: 'customer', id: c.id, name: c.name })} className="text-red-600 p-2">
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                  ))
                )}
              </div>
            </div>
          </div>
        )}

        {tab === 'input' && (
          <div className="bg-white rounded-xl shadow p-6 max-w-2xl mx-auto">
            <h2 className="text-lg font-bold mb-4">{editRec ? 'Edit' : 'Input'} Pencatatan</h2>
            {editRec && (
              <div className="bg-blue-50 border border-blue-300 rounded p-3 mb-4 text-sm flex justify-between">
                <span>Mode Edit</span>
                <button onClick={() => { setEditRec(null); setMeterForm({ cid: '', month: '', date: '', reading: '' }); }} className="text-blue-600">
                  Batal
                </button>
              </div>
            )}
            <div className="space-y-4">
              <select value={meterForm.cid} onChange={e => setMeterForm({ ...meterForm, cid: e.target.value })} className="w-full px-3 py-2 border rounded" disabled={editRec !== null}>
                <option value="">Pilih Pengguna</option>
                {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
              <div className="grid grid-cols-2 gap-4">
                <select value={meterForm.month} onChange={e => setMeterForm({ ...meterForm, month: e.target.value })} className="w-full px-3 py-2 border rounded">
                  <option value="">Bulan</option>
                  {months.map(m => <option key={m} value={m}>{m}</option>)}
                </select>
                <input type="number" value={meterForm.date} onChange={e => setMeterForm({ ...meterForm, date: e.target.value })} className="w-full px-3 py-2 border rounded" placeholder="Tanggal" min="1" max="31" />
              </div>
              {meterForm.cid && meterForm.month && (
                <div className="bg-blue-50 border-2 border-blue-300 rounded p-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <p className="text-xs text-gray-600">Meteran Awal</p>
                      <p className="text-3xl font-bold text-blue-600">{getPrev() || 0}</p>
                      <p className="text-xs">m³</p>
                    </div>
                    {meterForm.reading && (
                      <div>
                        <p className="text-xs text-gray-600">Volume</p>
                        <p className="text-3xl font-bold text-green-600">{calcVol()}</p>
                        <p className="text-xs">m³</p>
                      </div>
                    )}
                  </div>
                </div>
              )}
              <input type="number" value={meterForm.reading} onChange={e => setMeterForm({ ...meterForm, reading: e.target.value })} className="w-full px-3 py-2 border-2 rounded text-lg font-semibold" placeholder="Meteran Akhir (m³)" />
              {editRec ? (
                <button onClick={updateRec} className="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700">
                  Update
                </button>
              ) : (
                <button onClick={addRec} className="w-full bg-green-600 text-white py-3 rounded hover:bg-green-700">
                  Simpan
                </button>
              )}
            </div>
            {records.length > 0 && (
              <div className="mt-8 pt-6 border-t">
                <h3 className="font-bold mb-4">Terbaru</h3>
                <div className="space-y-2">
                  {records.slice(-5).reverse().map(r => (
                    <div key={r.id} className="border rounded p-4 bg-gray-50">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <p className="font-bold">{r.name}</p>
                          <p className="text-sm text-gray-600">{r.month} - Tgl {r.date}</p>
                          <p className="text-xs text-gray-500">Oleh: {r.by}</p>
                        </div>
                        <div className="text-right">
                          <p className="text-2xl font-bold text-green-600">{r.reading} m³</p>
                        </div>
                      </div>
                      <div className="flex justify-between items-center pt-2 border-t">
                        <span className="text-sm">Vol: <strong>{r.vol} m³</strong></span>
                        <div className="flex gap-2">
                          <button onClick={() => editRecord(r)} className="p-2 text-blue-600 hover:bg-blue-50 rounded">
                            <Edit2 className="w-4 h-4" />
                          </button>
                          <button onClick={() => setDel({ show: true, type: 'record', id: r.id, name: `${r.name} - ${r.month}` })} className="p-2 text-red-600 hover:bg-red-50 rounded">
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {tab === 'matrix' && (
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-bold mb-4">Matriks 2025</h2>
            {customers.length === 0 ? (
              <p className="text-center text-gray-400 py-12">Belum ada data</p>
            ) : (
              customers.map(c => {
                const recs = records.filter(r => r.cid === c.id);
                return (
                  <div key={c.id} className="mb-8 border-2 border-green-600 rounded overflow-hidden">
                    <div className="bg-green-600 text-white p-4">
                      <h3 className="font-bold text-lg">{c.name}</h3>
                      <p className="text-sm">{c.location} {c.business && `| ${c.business}`}</p>
                    </div>
                    <table className="w-full text-xs">
                      <thead>
                        <tr className="bg-gray-200">
                          <th className="border p-2" rowSpan="2">BULAN</th>
                          <th className="border p-2" colSpan="3">PENCATATAN</th>
                          <th className="border p-2" rowSpan="2">PETUGAS</th>
                        </tr>
                        <tr className="bg-gray-200">
                          <th className="border p-2">TGL</th>
                          <th className="border p-2">METER (m³)</th>
                          <th className="border p-2">VOL (m³)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {months.map((m, i) => {
                          const r = recs.find(x => x.month === m);
                          return (
                            <tr key={m} className={i % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                              <td className="border p-2 font-semibold">{m}</td>
                              <td className="border p-2 text-center">{r ? r.date : '-'}</td>
                              <td className="border p-2 text-center font-bold text-blue-600">{r ? r.reading : '-'}</td>
                              <td className="border p-2 text-center font-bold text-green-600">{r ? r.vol : '-'}</td>
                              <td className="border p-2 text-center text-xs">{r ? r.by : '-'}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                );
              })
            )}
          </div>
        )}
      </div>
    </div>
  );
}
